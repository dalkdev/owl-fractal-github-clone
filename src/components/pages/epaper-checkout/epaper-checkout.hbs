<div id="auth-modal" class="nw-fixed nw-inset-0 nw-bg-black nw-bg-opacity-50 nw-flex nw-items-center nw-justify-center nw-z-50 nw-hidden">
  <div class="nw-bg-white nw-rounded-lg nw-shadow-xl nw-max-w-md nw-w-full nw-mx-4 nw-max-h-screen nw-overflow-y-auto">
    <div class="nw-p-6">
      <div class="nw-flex nw-items-center nw-justify-between nw-mb-6">
        <div class="nw-flex nw-items-center nw-space-x-2">
          <div class="nw-w-8 nw-h-8 nw-rounded-lg nw-flex nw-items-center nw-justify-center" style="background-color: #0071A1;">
            <span class="nw-text-white nw-font-bold nw-text-sm">HK</span>
          </div>
          <h2 class="nw-text-xl nw-font-bold nw-text-gray-900">Haller Kreisblatt</h2>
        </div>
        <button id="close-auth-modal"  aria-label="Modal schließen" class="nw-text-gray-400 hover:nw-text-gray-600 nw-transition-colors">
          <svg class="nw-w-6 nw-h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div id="login-form" class="nw-space-y-6">
        <div class="nw-text-center nw-mb-6">
          <h3 class="nw-text-2xl nw-font-bold nw-text-gray-900 nw-mb-2">Willkommen zurück!</h3>
          <p class="nw-text-gray-600">Schön, dass Sie wieder da sind. Melden Sie sich an und lesen Sie weiter.</p>
        </div>

        <form id="login-form-submit">
          <div class="nw-space-y-4">
            <div>
              <label for="email" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                E-Mail-Adresse*
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent"
                placeholder="ihre@email.de"
              >
            </div>

            <div>
              <label for="password" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                Passwort*
              </label>
              <input id="password" type="password" name="password" required class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent" placeholder="Ihr Passwort">
            </div>

            <div class="nw-flex nw-items-center nw-justify-between">
              <div class="nw-flex nw-items-center">
                <input type="checkbox" id="remember" name="remember" class="nw-mr-2">
                <label for="remember" class="nw-text-sm nw-text-gray-600">
                  Angemeldet bleiben
                </label>
              </div>
              <button type="button" id="forgot-password-btn" class="nw-text-sm nw-underline hover:nw-no-underline" style="color: #0071A1;">
                Passwort vergessen?
              </button>
            </div>

            <button type="submit" class="nw-w-full nw-py-4 nw-px-4 nw-text-white nw-font-semibold nw-rounded-lg nw-transition-all nw-duration-200 hover:nw-opacity-90 nw-transform hover:nw-scale-105 nw-shadow-lg hover:nw-shadow-xl" style="background: linear-gradient(135deg, #0071A1 0%, #005a85 100%);">
                            <span class="nw-flex nw-items-center nw-justify-center">
                                <svg class="nw-w-5 nw-h-5 nw-mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                </svg>
                                Anmelden und loslesen
                            </span>
            </button>
          </div>
        </form>

        <div class="nw-text-center nw-mt-6">
          <p class="nw-text-gray-600 nw-text-sm">
            Noch kein Konto?
            <button id="show-register-btn" class="nw-font-medium nw-underline hover:nw-no-underline" style="color: #0071A1;">
              Jetzt registrieren
            </button>
          </p>
        </div>
      </div>

      <div id="register-form" class="nw-space-y-6 nw-hidden">
        <div class="nw-text-center nw-mb-6">
          <h3 class="nw-text-2xl nw-font-bold nw-text-gray-900 nw-mb-2">Ihr digitales Zeitungserlebnis startet hier!</h3>
          <p class="nw-text-gray-600">Erstellen Sie Ihr kostenloses Konto und starten Sie in wenigen Sekunden.</p>
        </div>

        <form id="register-form-submit">
          <div class="nw-space-y-4">
            <div class="nw-grid nw-grid-cols-2 nw-gap-4">
              <div>
                <label for="vorname" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                  Vorname*
                </label>
                <input id="vorname" type="text" name="firstName" required class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent" placeholder="Max">
              </div>
              <div>
                <label for="nachname" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                  Nachname*
                </label>
                <input id="nachname" type="text" name="lastName" required class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent" placeholder="Mustermann">
              </div>
            </div>

            <div>
              <label for="neuemail" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                E-Mail-Adresse*
              </label>
              <input id="neuemail" type="email" name="neuemail" required class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent" placeholder="ihre@email.de">
            </div>

            <div>
              <label for="neupassword" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                Passwort*
              </label>
              <input id="neupassword" type="password" name="neupassword" required class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent" placeholder="Mindestens 8 Zeichen">
            </div>

            <div>
              <label for="confirmPassword" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-1">
                Passwort bestätigen*
              </label>
              <input id="confirmPassword" type="password" name="confirmPassword" required class="nw-w-full nw-px-3 nw-py-2 nw-border nw-border-gray-300 nw-rounded-md nw-focus:outline-none nw-focus:ring-2 nw-focus:ring-blue-500 nw-focus:border-transparent" placeholder="Passwort wiederholen">
            </div>

            <div class="nw-space-y-3">
              <label for="acceptTerms" class="nw-flex nw-items-start">
                <input id="acceptTerms" type="checkbox" name="acceptTerms" required class="nw-mt-1 nw-mr-3">
                <span class="nw-text-sm nw-text-gray-700">
                                    Ich akzeptiere die <a href="/agb" class="nw-underline hover:nw-no-underline" style="color: #0071A1;">Allgemeinen Geschäftsbedingungen</a> und die <a href="/datenschutz" class="nw-underline hover:nw-no-underline" style="color: #0071A1;">Datenschutzerklärung</a>.*
                                </span>
              </label>

              <label for="newsletter" class="nw-flex nw-items-start">
                <input id="newsletter" type="checkbox" name="newsletter" class="nw-mt-1 nw-mr-3">
                <span class="nw-text-sm nw-text-gray-700">
                                    Ich möchte den kostenlosen Newsletter erhalten und über neue Angebote informiert werden.
                                </span>
              </label>
            </div>

            <button type="submit" class="nw-w-full nw-py-4 nw-px-4 nw-text-white nw-font-semibold nw-rounded-lg nw-transition-all nw-duration-200 hover:nw-opacity-90 nw-transform hover:nw-scale-105 nw-shadow-lg hover:nw-shadow-xl" style="background: linear-gradient(135deg, #0071A1 0%, #005a85 100%);">
                            <span class="nw-flex nw-items-center nw-justify-center">
                                <svg class="nw-w-5 nw-h-5 nw-mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                </svg>
                                Kostenloses Konto erstellen
                            </span>
            </button>
          </div>
        </form>

        <div class="nw-text-center nw-mt-6">
          <p class="nw-text-gray-600 nw-text-sm">
            Bereits ein Konto?
            <button id="show-login-btn" class="nw-font-medium nw-underline hover:nw-no-underline" style="color: #0071A1;">
              Anmelden
            </button>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="nw-min-h-screen" style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);">
  <a href="#main-content" class="nw-sr-only nw-sr-only-focusable nw-absolute nw-top-0 nw-left-0 nw-z-50 nw-bg-white nw-px-4 nw-py-2 nw-text-sm nw-font-medium nw-text-gray-900 nw-no-underline" style="color: #0071A1;">
    Zum Hauptinhalt springen
  </a>

  <main id="main-content" class="nw-max-w-4xl nw-mx-auto nw-px-4 sm:nw-px-6 nw-py-4 sm:nw-py-8" role="main" aria-label="E-Paper Bestellformular">
    <div class="nw-flex nw-justify-center sm:nw-justify-end nw-mb-4">
            <span class="nw-flex nw-items-center nw-bg-green-50 nw-px-3 sm:nw-px-4 nw-py-2 nw-rounded-full nw-text-sm nw-shadow-sm">
                <svg class="nw-w-4 nw-h-4 nw-mr-2 nw-text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <span class="nw-font-medium nw-text-green-700">Sicher bezahlen</span>
            </span>
    </div>

    <div class="nw-bg-white nw-rounded-2xl nw-shadow-lg nw-p-4 sm:nw-p-6 nw-mb-6" style="background: linear-gradient(135deg, #0071A1 0%, #005a85 100%);">
      <div class="nw-flex nw-items-start nw-justify-between nw-mb-4">
        <div class="nw-flex nw-items-start nw-space-x-3">
          <div class="nw-w-12 nw-h-10 sm:nw-w-16 sm:nw-h-12 nw-rounded-xl nw-flex nw-items-center nw-justify-center nw-bg-white nw-shadow-sm nw-flex-shrink-0">
            <svg class="nw-w-6 nw-h-6 sm:nw-w-8 sm:nw-h-8" style="color: #0071A1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div class="nw-flex-1 nw-min-w-0">
            <div class="nw-flex nw-items-center nw-space-x-2">
              <h2 class="nw-text-base sm:nw-text-lg nw-font-semibold nw-text-white">E-PAPER-ABO</h2>
              <button id="toggleDetails" class="nw-text-sm nw-text-white nw-text-opacity-80 nw-flex nw-items-center hover:nw-text-white nw-transition-transform nw-duration-200 nw-p-1 nw-min-h-[44px] nw-min-w-[44px]" aria-label="Details einblenden" aria-expanded="false" aria-controls="expandedDetails">
                <svg class="nw-w-4 nw-h-4 nw-transform nw-transition-transform nw-duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
            <p class="nw-text-sm nw-text-white nw-text-opacity-90 nw-pr-2">Die digitale 1:1 Version der gedruckten Ausgabe</p>

            <!-- Expanded Details -->
            <div id="expandedDetails" class="nw-hidden nw-mt-4 nw-space-y-3 nw-text-sm nw-text-white nw-text-opacity-90" aria-hidden="true">
              <div class="nw-mt-3">
                <h4 class="nw-font-semibold nw-text-white nw-mb-2">Ihre Vorteile:</h4>
                <ul class="nw-space-y-1" role="list">
                  <li class="nw-flex nw-items-start nw-space-x-2" role="listitem">
                    <span class="nw-text-white nw-mt-1" aria-hidden="true">•</span>
                    <span>Täglich ab 3:30 Uhr verfügbar</span>
                  </li>
                  <li class="nw-flex nw-items-start nw-space-x-2" role="listitem">
                    <span class="nw-text-white nw-mt-1" aria-hidden="true">•</span>
                    <span>HK am Sonntag & HK am Abend inklusive</span>
                  </li>
                  <li class="nw-flex nw-items-start nw-space-x-2" role="listitem">
                    <span class="nw-text-white nw-mt-1" aria-hidden="true">•</span>
                    <span>App-Zugang & Langzeitarchiv</span>
                  </li>
                  <li class="nw-flex nw-items-start nw-space-x-2" role="listitem">
                    <span class="nw-text-white nw-mt-1" aria-hidden="true">•</span>
                    <span>Auf bis zu vier Geräten gleichzeitig</span>
                  </li>
                  <li class="nw-flex nw-items-start nw-space-x-2" role="listitem">
                    <span class="nw-text-white nw-mt-1" aria-hidden="true">•</span>
                    <span>Mit HK-Karte bares Geld sparen</span>
                  </li>
                  <li class="nw-flex nw-items-start nw-space-x-2" role="listitem">
                    <span class="nw-text-white nw-mt-1" aria-hidden="true">•</span>
                    <span>Extras: Magazine, Beilagen, Rätsel</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="nw-text-right nw-flex-shrink-0">
          <div class="nw-text-2xl sm:nw-text-3xl nw-font-bold nw-text-white">31,90 €</div>
          <div class="nw-text-xs sm:nw-text-sm nw-text-white nw-text-opacity-90">monatlich</div>
        </div>
      </div>

      <div class="nw-bg-white  nw-rounded-xl nw-p-3 sm:nw-p-4 nw-mt-4 nw-text-sm">
        <div class="nw-flex nw-flex-col sm:nw-flex-row nw-items-center nw-justify-center nw-space-y-2 sm:nw-space-y-0 sm:nw-space-x-6">
          <div class="nw-text-center">
            <div class="nw-font-semibold nw-text-sm sm:nw-text-base" style="color: #0071A1;">Ohne Mindestlaufzeit</div>
          </div>
          <div class="nw-w-6 nw-h-px sm:nw-w-px sm:nw-h-6" style="background-color: #0071A1; opacity: 0.3;"></div>
          <div class="nw-text-center">
            <div class="nw-font-semibold nw-text-sm sm:nw-text-base" style="color: #0071A1;">Monatlich kündbar</div>
          </div>
        </div>
      </div>
    </div>

    <div class="nw-bg-white nw-rounded-2xl nw-shadow-lg nw-p-4 sm:nw-p-6">
      <h2 class="nw-text-xl sm:nw-text-2xl nw-font-bold nw-mb-6 sm:nw-mb-8 nw-text-center sm:nw-text-left" style="color: #0071A1;">Ihre Bestellung</h2>

      <nav class="nw-flex nw-items-center nw-justify-between nw-mb-6 sm:nw-mb-8 nw-px-2 sm:nw-px-0" role="navigation" aria-label="Bestellvorgang">
        <div class="nw-flex nw-flex-col sm:nw-flex-row nw-items-center">
          <div class="nw-w-8 nw-h-8 sm:nw-w-10 sm:nw-h-10 nw-rounded-full nw-text-white nw-flex nw-items-center nw-justify-center nw-font-semibold nw-text-xs sm:nw-text-sm nw-shadow-md" style="background: linear-gradient(135deg, #0071A1 0%, #005a85 100%);" aria-current="step">
            1
          </div>
          <span class="nw-mt-1 sm:nw-mt-0 sm:nw-ml-3 nw-text-xs sm:nw-text-sm nw-font-medium nw-text-center" style="color: #0071A1;">Kunde</span>
        </div>
        <div class="nw-flex-1 nw-h-1 nw-bg-gray-200 nw-mx-2 sm:nw-mx-4 nw-rounded-full nw-min-w-0" aria-hidden="true"></div>
        <div class="nw-flex nw-flex-col sm:nw-flex-row nw-items-center">
          <div class="nw-w-8 nw-h-8 sm:nw-w-10 sm:nw-h-10 nw-rounded-full nw-bg-gray-200 nw-text-gray-500 nw-flex nw-items-center nw-justify-center nw-font-semibold nw-text-xs sm:nw-text-sm">
            2
          </div>
          <span class="nw-mt-1 sm:nw-mt-0 sm:nw-ml-3 nw-text-xs sm:nw-text-sm nw-font-medium nw-text-gray-500 nw-text-center">Zahlung</span>
        </div>
        <div class="nw-flex-1 nw-h-1 nw-bg-gray-200 nw-mx-2 sm:nw-mx-4 nw-rounded-full nw-min-w-0" aria-hidden="true"></div>
        <div class="nw-flex nw-flex-col sm:nw-flex-row nw-items-center">
          <div class="nw-w-8 nw-h-8 sm:nw-w-10 sm:nw-h-10 nw-rounded-full nw-bg-gray-200 nw-text-gray-500 nw-flex nw-items-center nw-justify-center nw-font-semibold nw-text-xs sm:nw-text-sm">
            3
          </div>
          <span class="nw-mt-1 sm:nw-mt-0 sm:nw-ml-3 nw-text-xs sm:nw-text-sm nw-font-medium nw-text-gray-500 nw-text-center">Fertig</span>
        </div>
      </nav>

    <div id="auth-step" class="nw-space-y-6">
        <h3 class="nw-text-lg sm:nw-text-xl nw-font-semibold nw-mb-4 nw-text-center sm:nw-text-left" style="color: #0071A1;">Loggen Sie sich ein oder erstellen Sie ein Konto</h3>

        <div id="email-step" class="nw-space-y-4">
          <div class="nw-space-y-1">
            <label for="auth-email" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700">E-Mail-Adresse *</label>

            <input
              type="email"
              id="auth-email"
              class="nw-w-full nw-px-4 nw-py-3 nw-border nw-rounded-xl nw-text-base nw-border-gray-300 focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
              placeholder="ihre.email@beispiel.de"
              autocomplete="email"
              spellcheck="false"
              pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
            />
            <!-- Fehlerausgabe für JavaScript-Anpassung -->
            <p
              id="email-error"
              class="nw-text-sm nw-text-red-500 nw-mt-1 nw-hidden"
              aria-live="polite"
            ></p>
          </div>

          <button id="continue-btn" type="button" class="nw-w-full nw-py-4 sm:nw-py-4 nw-px-6 nw-text-white nw-font-semibold nw-text-base nw-rounded-xl nw-transition-all nw-duration-200 nw-shadow-lg hover:nw-shadow-xl nw-transform hover:nw-scale-105 nw-min-h-[48px] active:nw-scale-95" style="background: linear-gradient(135deg, #0071A1 0%, #005a85 100%) !important; color: white !important;" aria-describedby="continue-help">
            Weiter
          </button>
          <div id="continue-help" class="nw-sr-only">Klicken Sie hier, um mit Ihrer E-Mail-Adresse fortzufahren</div>
        </div>

        <div id="login-step" class="nw-hidden nw-space-y-4">
          <div>
            <label for="login-email" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">E-Mail-Adresse</label>
            <input type="email" id="login-email" name="login-email" readonly class="nw-w-full nw-px-4 nw-py-4 sm:nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base nw-bg-gray-50" maxlength="254" autocomplete="email" spellcheck="false" aria-label="Ihre E-Mail-Adresse">
          </div>
          <div>
            <label for="login-password" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Ihr Passwort *</label>
            <div class="nw-relative">
              <input type="password" id="login-password" name="login-password" required class="nw-w-full nw-px-4 nw-py-4 sm:nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200" maxlength="16" autocomplete="current-password" spellcheck="false" aria-describedby="login-password-help">
              <button type="button" id="toggle-password" class="nw-absolute nw-right-3 nw-top-1/2 nw-transform nw--translate-y-1/2 nw-text-gray-500 hover:nw-text-gray-700 nw-p-2 nw-min-h-[44px] nw-min-w-[44px]" aria-label="Passwort anzeigen" aria-pressed="false">
                <svg class="nw-w-5 nw-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
              </button>
            </div>
            <div id="login-password-help" class="nw-sr-only">Geben Sie Ihr Passwort ein</div>
          </div>
          <div class="nw-flex nw-flex-col sm:nw-flex-row nw-space-y-3 sm:nw-space-y-0 sm:nw-space-x-3">
            <button type="button" id="back-to-email" class="nw-flex-1 nw-py-4 nw-px-6 nw-font-medium nw-text-gray-700 nw-border nw-border-gray-300 nw-rounded-xl hover:nw-bg-gray-50 nw-transition-colors nw-duration-200 nw-min-h-[48px] active:nw-scale-95">
              Zurück
            </button>
            <button type="button" id="login-btn" class="nw-flex-1 nw-py-4 nw-px-6 nw-text-white nw-font-semibold nw-text-base nw-rounded-xl nw-transition-all nw-duration-200 nw-shadow-lg hover:nw-shadow-xl nw-transform hover:nw-scale-105 nw-min-h-[48px] active:nw-scale-95" style="background: linear-gradient(135deg, #0071A1 0%, #005a85 100%);">
              Anmelden
            </button>
          </div>
        </div>

        <div id="registration-step" class="nw-hidden nw-space-y-4">
          <div>
            <label for="register-email" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">E-Mail-Adresse</label>
            <input type="email" id="register-email" readonly class="nw-w-full nw-px-4 nw-py-4 sm:nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base nw-bg-gray-50" maxlength="254" autocomplete="email" spellcheck="false">
          </div>

          <div>
            <label for="register-password" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Ihr Passwort *</label>
            <div class="nw-relative">
              <input type="password" id="register-password" required
                     class="nw-w-full nw-px-4 nw-py-4 sm:nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
                     maxlength="16" autocomplete="new-password" spellcheck="false">
              <button type="button" id="toggle-register-password" aria-label="Passwort anzeigen"
                      class="nw-absolute nw-right-3 nw-top-1/2 nw-transform nw--translate-y-1/2 nw-text-gray-500 hover:nw-text-gray-700 nw-p-2">
                <svg class="nw-w-5 nw-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
              </button>
            </div>

            <!-- Hier die Fehlernachricht -->
            <p id="register-password-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
          </div>


          <div>
            <label class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-3">Ich bin:</label>
            <div class="nw-flex nw-flex-col sm:nw-flex-row nw-space-y-3 sm:nw-space-y-0 sm:nw-space-x-6">
              <label class="nw-flex nw-items-center nw-p-2">
                <input type="radio" name="customer-type" value="private" checked class="nw-w-5 nw-h-5 nw-border-gray-300 focus:nw-ring-2" style="color: #0071A1;">
                <span class="nw-ml-3 nw-text-sm nw-text-gray-700">Privatkunde</span>
              </label>
              <label class="nw-flex nw-items-center nw-p-2">
                <input type="radio" name="customer-type" value="business" class="nw-w-5 nw-h-5 nw-border-gray-300 focus:nw-ring-2" style="color: #0071A1;">
                <span class="nw-ml-3 nw-text-sm nw-text-gray-700">Firma</span>
              </label>
            </div>
          </div>

          <div>
            <label for="salutation" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Anrede *</label>
            <select id="salutation" required
                    class="nw-w-full nw-px-4 nw-py-4 sm:nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200">
              <option value="">Bitte wählen</option>
              <option value="herr">Herr</option>
              <option value="frau">Frau</option>
              <option value="divers">Divers</option>
            </select>
            <p id="salutation-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
          </div>

          <div class="nw-grid nw-grid-cols-1 md:nw-grid-cols-2 nw-gap-4">
            <div>
              <label for="first-name" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Vorname *</label>
              <input type="text" id="first-name" required
                     class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
                     maxlength="50" autocomplete="given-name" spellcheck="false">
              <p id="first-name-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
            </div>

            <div>
              <label for="last-name" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Nachname *</label>
              <input type="text" id="last-name" required
                     class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
                     maxlength="50" autocomplete="family-name" spellcheck="false">
              <p id="last-name-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
            </div>
          </div>

          <div>
            <label for="street" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Straße & Nr. *</label>
            <input type="text" id="street" required
                   class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
                   maxlength="100" autocomplete="street-address" spellcheck="false">
            <p id="street-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
          </div>

          <div class="nw-grid nw-grid-cols-1 md:nw-grid-cols-3 nw-gap-4">
            <div>
              <label for="postal-code" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">PLZ *</label>
              <input type="text" id="postal-code" required
                     class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
                     maxlength="5" pattern="[0-9]{5}" autocomplete="postal-code" spellcheck="false">
              <p id="postal-code-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
            </div>
            <div>
              <label for="city" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Ort *</label>
              <input type="text" id="city" required
                     class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200"
                     maxlength="50" autocomplete="address-level2" spellcheck="false">
              <p id="city-error" class="nw-text-xs nw-text-red-500 nw-mt-1 nw-hidden" aria-live="polite"></p>
            </div>
            <div>
              <label for="country" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Land</label>
              <select id="country" class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200">
                <option value="DE" selected>Deutschland</option>
                <option value="AT">Österreich</option>
                <option value="CH">Schweiz</option>
              </select>
            </div>
          </div>

          <div>
            <label for="phone" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Telefon (Rufnummer)</label>
            <input type="tel" id="phone" class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200" maxlength="20" autocomplete="tel" spellcheck="false">
          </div>

          <div>
            <label for="birth-date" class="nw-block nw-text-sm nw-font-medium nw-text-gray-700 nw-mb-2">Ihr Geburtsdatum</label>
            <input type="date" id="birth-date" class="nw-w-full nw-px-4 nw-py-3 nw-border nw-border-gray-300 nw-rounded-xl nw-text-base focus:nw-ring-2 focus:nw-border-transparent nw-transition-all nw-duration-200" min="1900-01-01" max="2010-12-31" autocomplete="bday">
          </div>

          <p class="nw-text-xs nw-text-gray-500 nw-mb-4">* hierbei handelt es sich um ein Pflichtfeld</p>

          <div class="nw-flex nw-space-x-3">
            <button type="button" id="back-to-email-from-register" class="nw-flex-1 nw-py-4 nw-px-6 nw-font-medium nw-text-gray-700 nw-border nw-border-gray-300 nw-rounded-xl hover:nw-bg-gray-50 nw-transition-colors nw-duration-200">
              Zurück
            </button>
            <button type="button" id="register-btn" class="nw-flex-1 nw-py-4 nw-px-6 nw-font-medium nw-text-white nw-rounded-xl nw-transition-all nw-duration-200 nw-shadow-lg hover:nw-shadow-xl nw-transform hover:nw-scale-105" style="background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);">
              Weiter
              <svg class="nw-w-4 nw-h-4 nw-ml-2 nw-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>






    </div>

    <div class="nw-bg-white nw-rounded-2xl nw-shadow-lg nw-p-6 nw-mt-6">
      <h3 class="nw-text-lg nw-font-semibold nw-mb-4" style="color: #0071A1;">BRAUCHEN SIE HILFE?</h3>

      <div class="nw-flex nw-flex-col md:nw-flex-row nw-gap-4">
        <div class="nw-flex nw-items-center  nw-px-4 nw-py-3 nw-rounded-xl nw-flex-1" style="background-color: #E6F3F8;">
          <svg class="nw-w-5 nw-h-5 nw-mr-3" style="color: #0071A1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
          <a href="mailto:service@haller-kreisblatt.de" class="nw-text-gray-700 hover:nw-text-gray-900 nw-underline nw-text-sm">service@haller-kreisblatt.de</a>
        </div>

        <div class="nw-flex nw-items-center nw-bg-green-50 nw-px-4 nw-py-3 nw-rounded-xl nw-flex-1">
          <svg class="nw-w-5 nw-h-5 nw-mr-3 nw-text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
          </svg>
          <a href="tel:05201150100" class="nw-text-gray-700 hover:nw-text-gray-900 nw-underline nw-text-sm">05201 150 100</a>
        </div>
      </div>
    </div>

    <div class="nw-flex nw-justify-center nw-items-center nw-space-x-3 nw-mt-6">
      <img src="/images/zahlen-methoden/payment_creditcard.svg" alt="Credit Card"/>
      <img src="/images/zahlen-methoden/payment_paypal_badge.svg" alt="PayPal" />
      <img src="/images/zahlen-methoden/payment_sepa.svg" alt="Sepa"/>
    </div>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    // Security: Prevent console access in production
    if (typeof console !== 'undefined' && window.location.hostname !== 'localhost') {
      console.log = console.warn = console.error = function() {};
    }
    // Security: Rate limiting for form submissions
    const rateLimiter = {
      attempts: 0,
      lastAttempt: 0,
      maxAttempts: 5,
      cooldownPeriod: 60000, // 1 minute
      canAttempt() {
        const now = Date.now();
        if (now - this.lastAttempt > this.cooldownPeriod) {
          this.attempts = 0;
        }
        return this.attempts < this.maxAttempts;
      },
      recordAttempt() {
        this.attempts++;
        this.lastAttempt = Date.now();
      },
      getRemainingTime() {
        const remaining = this.cooldownPeriod - (Date.now() - this.lastAttempt);
        return Math.ceil(remaining / 1000);
      }
    };
    // Security: Input sanitization
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/[<>&"']/g, function(match) {
        const escapeMap = {
          '<': '&lt;',
          '>': '&gt;',
          '&': '&amp;',
          '"': '&quot;',
          "'": '&#x27;'
        };
        return escapeMap[match];
      }).trim();
    }
    // Security: Enhanced email validation
    function validateEmail(email) {
      const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}$/;
      return emailRegex.test(email) && email.length <= 254;
    }
    // Security: Password strength validation
    function validatePassword(password) {
      if (password.length < 6 || password.length > 16) {
        return {
          valid: false,
          message: 'Passwort muss zwischen 6 und 16 Zeichen lang sein.'
        };
      }
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
        return {
          valid: false,
          message: 'Passwort muss Groß- und Kleinbuchstaben sowie Zahlen enthalten.'
        };
      }
      return {
        valid: true,
        message: ''
      };
    }

    const passwordInput = document.getElementById('register-password');
    const errorMessage = document.getElementById('register-password-error');

    passwordInput.addEventListener('input', () => {
      const { valid, message } = validatePassword(passwordInput.value);

      if (valid) {
        errorMessage.textContent = '';
        errorMessage.classList.add('nw-hidden');
      } else {
        errorMessage.textContent = message;
        errorMessage.classList.remove('nw-hidden');
      }
    });
    // Security: CSRF token simulation
    function generateCSRFToken() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }
    const csrfToken = generateCSRFToken();
    // Screen reader announcements for accessibility
    function announceToScreenReader(message) {
      const announcement = document.createElement('div');
      announcement.setAttribute('aria-live', 'polite');
      announcement.setAttribute('aria-atomic', 'true');
      announcement.className = 'nw-sr-only';
      announcement.textContent = message;
      document.body.appendChild(announcement);
      // Remove after announcement
      setTimeout(() => {
        if (announcement.parentNode) {
          announcement.parentNode.removeChild(announcement);
        }
      }, 1000);
    }
    const emailStep = document.getElementById('email-step');
    const loginStep = document.getElementById('login-step');
    const registrationStep = document.getElementById('registration-step');
    const continueBtn = document.getElementById('continue-btn');
    const emailInput = document.getElementById('auth-email');
    const loginEmail = document.getElementById('login-email');
    const registerEmail = document.getElementById('register-email');
    // Back buttons
    const backToEmailBtn = document.getElementById('back-to-email');
    const backToEmailFromRegisterBtn = document.getElementById('back-to-email-from-register');
    // Password toggles
    const togglePassword = document.getElementById('toggle-password');
    const toggleRegisterPassword = document.getElementById('toggle-register-password');
    const loginPassword = document.getElementById('login-password');
    const registerPassword = document.getElementById('register-password');
    // Submit buttons
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    // Security: Secure SSO check function with proper validation
    async function checkSSOEmail(email) {
      if (!validateEmail(email)) {
        throw new Error('Ungültige E-Mail-Adresse');
      }
      // Security: Sanitize email before sending
      const sanitizedEmail = sanitizeInput(email);
      try {
        // In real implementation, this would be a secure API call with proper authentication
        const response = await fetch('/api/auth/check-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            email: sanitizedEmail,
            timestamp: Date.now()
          })
        });
        if (!response.ok) {
          throw new Error('Netzwerkfehler beim Prüfen der E-Mail');
        }
        const data = await response.json();
        return data.exists;
      } catch (error) {
        // Fallback to mock for development
        console.warn('Using mock SSO check due to:', error.message);
        return new Promise((resolve) => {
          setTimeout(() => {
            const existingEmails = [
              'test@haller-kreisblatt.de',
              'admin@haller-kreisblatt.de',
              'user@example.com'
            ];
            resolve(existingEmails.includes(sanitizedEmail.toLowerCase()));
          }, 500);
        });
      }
    }
    // Show steps
    function showStep(step) {
      emailStep.classList.add('nw-hidden');
      loginStep.classList.add('nw-hidden');
      registrationStep.classList.add('nw-hidden');
      step.classList.remove('nw-hidden');
    }
    // Continue button handler with security validation
    if (continueBtn && emailInput) {
      continueBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        // Security: Rate limiting check
        if (!rateLimiter.canAttempt()) {
          alert(`Zu viele Versuche. Bitte warten Sie ${rateLimiter.getRemainingTime()} Sekunden.`);
          return;
        }
        const email = sanitizeInput(emailInput.value);
        const emailErrorText = document.getElementById('email-error');

// Reset visuelle Fehleranzeige
        emailInput.classList.remove('nw-border-red-500');
        emailErrorText?.classList.add('nw-hidden');

// Leere Eingabe prüfen
        if (!email) {
          emailInput.classList.add('nw-border-red-500');
          if (emailErrorText) {
            emailErrorText.textContent = 'Bitte geben Sie Ihre E-Mail-Adresse ein.';
            emailErrorText.classList.remove('nw-hidden');
          }
          return;
        }

// Ungültige E-Mail prüfen
        if (!validateEmail(email)) {
          emailInput.classList.add('nw-border-red-500');
          if (emailErrorText) {
            emailErrorText.textContent = 'Bitte geben Sie eine gültige E-Mail-Adresse ein.';
            emailErrorText.classList.remove('nw-hidden');
          }
          return;
        }

        // Security: Record attempt
        rateLimiter.recordAttempt();
        // Show loading state
        continueBtn.disabled = true;
        continueBtn.textContent = 'Prüfe E-Mail...';
        try {
          // Check if email exists in SSO
          const emailExists = await checkSSOEmail(email);
          if (emailExists) {
            // Show login form
            loginEmail.value = email;
            showStep(loginStep);
            setTimeout(() => loginPassword.focus(), 100);
          } else {
            // Show registration form
            registerEmail.value = email;
            showStep(registrationStep);
            setTimeout(() => registerPassword.focus(), 100);
          }
        } catch (error) {
          alert('Fehler beim Prüfen der E-Mail. Bitte versuchen Sie es erneut.');
          console.error('SSO check error:', error);
        } finally {
          continueBtn.disabled = false;
          continueBtn.textContent = 'Weiter';
        }
      });
      // Enter key support with security validation
      emailInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          continueBtn.click();
        }
      });
      // Security: Prevent paste of malicious content
      emailInput.addEventListener('paste', function(e) {
        setTimeout(() => {
          this.value = sanitizeInput(this.value);
        }, 0);
      });
    }
    // Back button handlers
    if (backToEmailBtn) {
      backToEmailBtn.addEventListener('click', function() {
        showStep(emailStep);
        emailInput.focus();
      });
    }
    if (backToEmailFromRegisterBtn) {
      backToEmailFromRegisterBtn.addEventListener('click', function() {
        showStep(emailStep);
        emailInput.focus();
      });
    }
    // Password toggle handlers
    if (togglePassword && loginPassword) {
      togglePassword.addEventListener('click', function() {
        const type = loginPassword.type === 'password' ? 'text' : 'password';
        loginPassword.type = type;
        // Update icon
        const svg = togglePassword.querySelector('svg');
        if (type === 'text') {
          svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>';
        } else {
          svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>';
        }
      });
    }
    if (toggleRegisterPassword && registerPassword) {
      toggleRegisterPassword.addEventListener('click', function() {
        const type = registerPassword.type === 'password' ? 'text' : 'password';
        registerPassword.type = type;
        // Update icon
        const svg = toggleRegisterPassword.querySelector('svg');
        if (type === 'text') {
          svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>';
        } else {
          svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>';
        }
      });
    }
    // Login button handler with security validation
    if (loginBtn) {
      loginBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        // Security: Rate limiting check
        if (!rateLimiter.canAttempt()) {
          alert(`Zu viele Versuche. Bitte warten Sie ${rateLimiter.getRemainingTime()} Sekunden.`);
          return;
        }
        const password = sanitizeInput(loginPassword.value);
        if (!password) {
          alert('Bitte geben Sie Ihr Passwort ein.');
          return;
        }
        // Security: Record attempt
        rateLimiter.recordAttempt();
        // Show loading state
        loginBtn.disabled = true;
        loginBtn.textContent = 'Anmelden...';
        try {
          // Security: Secure API call with proper authentication
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
              email: sanitizeInput(loginEmail.value),
              password: password, // Password should be hashed on server
              timestamp: Date.now()
            })
          });
          if (!response.ok) {
            throw new Error('Login fehlgeschlagen');
          }
          const data = await response.json();
          if (data.success) {
            alert('Anmeldung erfolgreich! Weiter zur Zahlungsauswahl...');
            // Here you would proceed to next step
          } else {
            alert(data.message || 'Anmeldung fehlgeschlagen');
          }
        } catch (error) {
          console.warn('Using mock login due to:', error.message);
          // Mock login for development
          setTimeout(() => {
            alert('Anmeldung erfolgreich! Weiter zur Zahlungsauswahl...');
          }, 1000);
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Anmelden';
        }
      });
    }
    // Register button handler with security validation
    if (registerBtn) {
      registerBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        // Security: Rate limiting check
        if (!rateLimiter.canAttempt()) {
          alert(`Zu viele Versuche. Bitte warten Sie ${rateLimiter.getRemainingTime()} Sekunden.`);
          return;
        }

        const requiredFields = {
          'register-password': 'Passwort',
          'salutation': 'Anrede',
          'first-name': 'Vorname',
          'last-name': 'Nachname',
          'street': 'Straße & Nr.',
          'postal-code': 'PLZ',
          'city': 'Ort'
        };

        const sanitizedData = {};
        let firstErrorField = null;

        function setError(field, message) {
          field.classList.add('nw-border-red-500');
          const errorElem = document.getElementById(field.id + '-error');
          if (errorElem) {
            errorElem.textContent = message;
            errorElem.classList.remove('nw-hidden');
          }
        }

        function clearError(field) {
          field.classList.remove('nw-border-red-500');
          const errorElem = document.getElementById(field.id + '-error');
          if (errorElem) {
            errorElem.textContent = '';
            errorElem.classList.add('nw-hidden');
          }
        }

        // Clear all errors first
        for (const fieldId of Object.keys(requiredFields)) {
          const field = document.getElementById(fieldId);
          if (field) clearError(field);
        }
        clearError(registerPassword);
        // Password validation
        const password = sanitizeInput(registerPassword.value);
        clearError(registerPassword);
        const passwordValidation = validatePassword(password);
        if (!passwordValidation.valid) {
          setError(registerPassword, passwordValidation.message);
          if (!firstErrorField) firstErrorField = registerPassword;
        }

        // Validate required fields
        for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
          const field = document.getElementById(fieldId);
          const value = sanitizeInput(field?.value || '');
          if (!value) {
            setError(field, 'Dieses Feld ist erforderlich');
            if (!firstErrorField) firstErrorField = field;
            continue;
          }
          if (fieldId === 'postal-code' && !/^\d{5}$/.test(value)) {
            setError(field, 'PLZ muss aus 5 Ziffern bestehen.');
            if (!firstErrorField) firstErrorField = field;
            continue;
          }
          if ((fieldId === 'first-name' || fieldId === 'last-name') && value.length < 2) {
            setError(field, `${fieldName} muss mindestens 2 Zeichen lang sein.`);
            if (!firstErrorField) firstErrorField = field;
            continue;
          }
          sanitizedData[fieldId] = value;
        }



        if (firstErrorField) {
          firstErrorField.focus();
          return;
        }

        // Security: Record attempt
        rateLimiter.recordAttempt();

        // Show loading state
        registerBtn.disabled = true;
        registerBtn.textContent = 'Registrierung...';

        try {
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
              ...sanitizedData,
              email: sanitizeInput(registerEmail.value),
              password: password, // Password should be hashed on server
              customerType: document.querySelector('input[name="customer-type"]:checked')?.value || 'private',
              country: sanitizeInput(document.getElementById('country')?.value || 'DE'),
              phone: sanitizeInput(document.getElementById('phone')?.value || ''),
              birthDate: sanitizeInput(document.getElementById('birth-date')?.value || ''),
              timestamp: Date.now()
            })
          });

          if (!response.ok) {
            throw new Error('Registrierung fehlgeschlagen');
          }
          const data = await response.json();

          if (data.success) {
            alert('Registrierung erfolgreich! Weiter zur Zahlungsauswahl...');
            // Hier weitere Schritte
          } else {
            alert(data.message || 'Registrierung fehlgeschlagen');
          }

        } catch (error) {
          console.warn('Using mock registration due to:', error.message);
          setTimeout(() => {
            alert('Registrierung erfolgreich! Weiter zur Zahlungsauswahl...');
          }, 1000);
        } finally {
          registerBtn.disabled = false;
          registerBtn.innerHTML = 'Weiter <svg class="nw-w-4 nw-h-4 nw-ml-2 nw-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
        }
      });
    }

    // E-Paper details toggle functionality with accessibility
    const toggleButton = document.getElementById('toggleDetails');
    const expandedDetails = document.getElementById('expandedDetails');
    if (toggleButton && expandedDetails) {
      const toggleIcon = toggleButton.querySelector('svg');
      toggleButton.addEventListener('click', function() {
        const isExpanded = !expandedDetails.classList.contains('nw-hidden');
        if (isExpanded) {
          // Collapse
          expandedDetails.classList.add('nw-hidden');
          toggleIcon.style.transform = 'rotate(0deg)';
          toggleButton.setAttribute('aria-expanded', 'false');
          toggleButton.setAttribute('aria-label', 'Details einblenden');
          expandedDetails.setAttribute('aria-hidden', 'true');
          announceToScreenReader('Details ausgeblendet');
        } else {
          // Expand
          expandedDetails.classList.remove('nw-hidden');
          toggleIcon.style.transform = 'rotate(180deg)';
          toggleButton.setAttribute('aria-expanded', 'true');
          toggleButton.setAttribute('aria-label', 'Details ausblenden');
          expandedDetails.setAttribute('aria-hidden', 'false');
          announceToScreenReader('Details eingeblendet');
        }
      });
      // Keyboard support for toggle
      toggleButton.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleButton.click();
        }
      });
    }
    // Security: Additional protection measures
    // Prevent form resubmission on page refresh
    if (window.history.replaceState) {
      window.history.replaceState(null, null, window.location.href);
    }
    // Security: Disable right-click context menu on sensitive areas
    document.addEventListener('contextmenu', function(e) {
      if (e.target.type === 'password' || e.target.type === 'email') {
        e.preventDefault();
      }
    });
    // Security: Prevent form data from being cached
    window.addEventListener('beforeunload', function() {
      // Clear sensitive form data
      const sensitiveFields = ['auth-email', 'login-password', 'register-password', 'login-email', 'register-email'];
      sensitiveFields.forEach(id => {
        const field = document.getElementById(id);
        if (field) field.value = '';
      });
    });
    // Security: Monitor for suspicious activity
    let keyloggerDetection = {
      keyCount: 0,
      startTime: Date.now(),
      checkSuspiciousActivity() {
        const now = Date.now();
        const timeDiff = now - this.startTime;
        if (timeDiff < 1000 && this.keyCount > 50) {
          console.warn('Suspicious rapid keystrokes detected');
          // In production, this would trigger additional security measures
        }
        if (timeDiff > 5000) {
          this.keyCount = 0;
          this.startTime = now;
        }
      }
    };
    document.addEventListener('keydown', function() {
      keyloggerDetection.keyCount++;
      keyloggerDetection.checkSuspiciousActivity();
    });
    // Security: Prevent copying of sensitive information
    document.addEventListener('copy', function(e) {
      const selection = window.getSelection().toString();
      if (selection.includes('@') || selection.length > 20) {
        console.warn('Copy attempt detected for potential sensitive data');
        // In production, this might block the copy or log the event
      }
    });
    // Security: Add security headers via meta tags (for browsers that support it)
    const securityMeta = document.createElement('meta');
    securityMeta.httpEquiv = 'Content-Security-Policy';
    securityMeta.content = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-src 'none'; object-src 'none';";
    document.head.appendChild(securityMeta);
    // Security: Form validation on all input changes
    const allInputs = document.querySelectorAll('input, select');
    allInputs.forEach(input => {
      input.addEventListener('input', function() {
        this.value = sanitizeInput(this.value);
      });
      input.addEventListener('blur', function() {
        this.value = sanitizeInput(this.value);
      });
    });
    console.log('Security measures initialized');
  });
  // Load mobile interactions
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize mobile-specific features
    if (window.innerWidth < 768) {
      // Add mobile-specific classes
      document.body.classList.add('nw-mobile-optimized');
      // Enhanced touch feedback
      const buttons = document.querySelectorAll('button, input[type="button"], input[type="submit"]');
      buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
          this.style.transform = 'scale(0.95)';
        });
        button.addEventListener('touchend', function() {
          this.style.transform = 'scale(1)';
        });
      });
      // Prevent double-tap zoom
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      // Auto-scroll to inputs when keyboard opens
      const inputs = document.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          setTimeout(() => {
            this.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          }, 300);
        });
      });
    }
  });
</script>

<link rel="stylesheet" href="/accessibility.css">

<style>
  /* Security: Prevent form field highlighting for screenshots */
  input[type="password"],
  input[type="email"] {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  input[type="password"]::-ms-reveal {
    display: none;
  }

  /* Security: Prevent autocomplete styling leakage */
  input:-webkit-autofill,
  input:-webkit-autofill:hover,
  input:-webkit-autofill:focus {
    -webkit-box-shadow: 0 0 0 30px white inset !important;
    -webkit-text-fill-color: #374151 !important;
  }

  /* Security: Hide sensitive content during print */
  @media print {

    input[type="password"],
    input[type="email"] {
      visibility: hidden;
    }
  }

  /* CRITICAL FIX: Ensure button visibility and override accessibility CSS conflicts */
  #continue-btn,
  #login-btn,
  #register-btn {
    background: linear-gradient(135deg, #0071A1 0%, #005a85 100%) !important;
    color: white !important;
    border: none !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  #continue-btn:focus,
  #login-btn:focus,
  #register-btn:focus {
    background: linear-gradient(135deg, #005a85 0%, #004a6d 100%) !important;
    color: white !important;
    outline: 2px solid #0071A1 !important;
    outline-offset: 2px !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  #continue-btn:hover,
  #login-btn:hover,
  #register-btn:hover {
    background: linear-gradient(135deg, #005a85 0%, #004a6d 100%) !important;
    color: white !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* Ensure back buttons are visible */
  #back-to-email,
  #back-to-email-from-register {
    background: white !important;
    color: #374151 !important;
    border: 1px solid #d1d5db !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  #back-to-email:focus,
  #back-to-email-from-register:focus {
    background: #f9fafb !important;
    color: #374151 !important;
    outline: 2px solid #0071A1 !important;
    outline-offset: 2px !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
</style>